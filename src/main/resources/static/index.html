<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>404Jerry API Tester - v1.3</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f8f9fa; font-size: 0.85rem; }
    .log-panel { background: #212529; color: #00ff00; height: 350px; overflow-y: auto; padding: 15px; font-family: 'Courier New', monospace; border-radius: 8px; }
    .card { border: none; margin-bottom: 20px; }
    #chat-board { height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; }
    .chat-item { margin-bottom: 10px; }
    .badge-user { font-size: 0.7rem; margin-right: 5px; }
  </style>
</head>
<body>

<div class="container-fluid py-4">
  <header class="mb-4 d-flex justify-content-between align-items-center bg-white p-3 shadow-sm rounded border-start border-primary border-4">
    <h2 class="h4 mb-0 text-primary">üöÄ 404Jerry Debugger <small class="text-muted" style="font-size: 0.7rem;">JWT & WebSocket</small></h2>
    <div>
      <span id="user-display" class="badge bg-dark me-2">Guest</span>
      <button id="ws-connect-btn" class="btn btn-sm btn-outline-danger" onclick="connect()">Connect WebSocket</button>
      <span id="token-status" class="badge bg-danger ms-2">No Token</span>
    </div>
  </header>

  <div class="row">
    <div class="col-lg-7">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white fw-bold">1. Authentication</div>
        <div class="card-body row g-2">
          <div class="col-8">
            <input type="text" id="login-email" class="form-control form-control-sm mb-1" placeholder="Email">
            <input type="password" id="login-pw" class="form-control form-control-sm" placeholder="Password">
          </div>
          <div class="col-4 d-grid gap-1">
            <button onclick="login()" class="btn btn-sm btn-primary">Login</button>
            <button class="btn btn-sm btn-light text-danger" onclick="logout()">Reset</button>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white fw-bold">2. Room Control</div>
        <div class="card-body">
          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text bg-light fw-bold">Room ID</span>
            <input type="text" id="target-id" class="form-control" value="1" placeholder="ID">
          </div>
          <button onclick="apiAction('GET', `/api/games/by-room/${$('#target-id').value}`)" class="btn btn-sm btn-outline-dark w-100">Check Game Status</button>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-info text-white fw-bold d-flex justify-content-between align-items-center">
          3. Live Chat
          <button onclick="fetchChatHistory()" class="btn btn-xs btn-light py-0" style="font-size: 0.7rem;">History</button>
        </div>
        <div class="card-body">
          <div id="chat-board" class="p-3 mb-3 border shadow-inner"></div>
          <div class="input-group">
            <input type="text" id="chat-input" class="form-control" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." onkeypress="if(event.keyCode==13) processChat()">
            <button onclick="processChat()" class="btn btn-primary px-4">Î≥¥ÎÇ¥Í∏∞</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center fw-bold">
          Console Logs
          <button class="btn btn-xs btn-outline-light py-0" style="font-size: 0.7rem;" onclick="$('#log').innerHTML=''">Clear</button>
        </div>
        <div id="log" class="log-panel small"></div>
      </div>
    </div>
  </div>
</div>

<script>
  const $ = (q) => document.querySelector(q);
  const API_BASE = 'http://localhost:8080';
  let stompClient = null;
  let myUserInfo = null; // Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†Ä Ï†ïÎ≥¥Î•º Ï†ÄÏû•

  // --- 1. Î°úÍ∑∏Ïù∏ Î°úÏßÅ (Ïú†Ï†Ä Ï†ïÎ≥¥ ÏûêÎèô Í∞±Ïã† Ìè¨Ìï®) ---
  async function login() {
    const data = { email: $('#login-email').value, password: $('#login-pw').value };
    try {
      const res = await apiAction('POST', '/api/auth/login', data);
      if(res.accessToken) {
        localStorage.setItem('accessToken', res.accessToken);
        await getMyInfo(); // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ Ï¶âÏãú ÎÇ¥ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
      }
    } catch(e) {}
  }

  async function getMyInfo() {
    try {
      const user = await apiAction('GET', '/api/users/me');
      myUserInfo = user; // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû• (ID ÌôúÏö©)
      $('#user-display').innerText = `${user.nickname || 'User'} (ID: ${user.id})`;
      $('#user-display').className = 'badge bg-success me-2';
      updateAuthStatus(true);
    } catch(e) {
      updateAuthStatus(false);
    }
  }

  function logout() {
    localStorage.clear();
    location.reload();
  }

  // --- 2. HTTP API (JWT Ìó§Îçî Ìè¨Ìï®) ---
  async function apiAction(method, url, data = null) {
    const token = localStorage.getItem('accessToken');
    const config = {
      method: method,
      url: API_BASE + url,
      headers: token ? { 'Authorization': `Bearer ${token}` } : {},
      data: data
    };
    addLog(`>> [REQ] ${method} ${url}`);
    try {
      const res = await axios(config);
      addLog(`<< [RES] ${JSON.stringify(res.data, null, 2)}`);
      return res.data;
    } catch (err) {
      addLog(`!! [ERR] ${err.response?.status || 'Network Error'}`);
      throw err;
    }
  }

  // --- 3. WebSocket/STOMP (JWT Í≤ÄÏ¶ù Ìè¨Ìï®) ---
  function connect() {
    const token = localStorage.getItem('accessToken');
    if(!token) return alert("Î°úÍ∑∏Ïù∏ÏùÑ Î®ºÏ†Ä Ìï¥Ï£ºÏÑ∏Ïöî (JWT ÌïÑÏöî)");

    const socket = new SockJS(`${API_BASE}/ws-stomp`);
    stompClient = Stomp.over(socket);

    // STOMP Ïó∞Í≤∞ Ìó§ÎçîÏóê JWT ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä
    const headers = { 'Authorization': `Bearer ${token}` };

    stompClient.connect(headers, function (frame) {
      addLog('>> [WS] Ïó∞Í≤∞ ÏÑ±Í≥µ (JWT Ïù∏Ï¶ù ÏôÑÎ£å)');
      $('#ws-connect-btn').innerText = 'Connected';
      $('#ws-connect-btn').className = 'btn btn-sm btn-success';

      const roomId = $('#target-id').value || '1';
      stompClient.subscribe(`/sub/chat/room/${roomId}`, function (response) {
        const msg = JSON.parse(response.body);
        // ÎÇ¥ IDÏôÄ Î≥¥ÎÇ∏ ÏÇ¨Îûå ID ÎπÑÍµêÌïòÏó¨ Î∞©Ìñ• Í≤∞Ï†ï
        const isMe = myUserInfo && (msg.senderId === myUserInfo.id);
        appendToChatBoard(msg.senderId, msg.message, isMe);
        addLog(`<< [RECV] From ${msg.senderId}: ${msg.message}`);
      });
    }, function (err) {
      addLog('!! [WS ERROR] ' + err);
    });
  }

  // --- 4. Ïã§ÏãúÍ∞Ñ Ï±ÑÌåÖ Ï†ÑÏÜ° (ÏûêÎèô ID Ïó∞Îèô) ---
  function processChat() {
    const input = $('#chat-input');
    const message = input.value;
    const roomId = parseInt($('#target-id').value) || 1;

    if(!myUserInfo) return alert("Ïú†Ï†Ä Ï†ïÎ≥¥Î•º Î®ºÏ†Ä Î∂àÎü¨ÏôÄÏïº Ìï©ÎãàÎã§.");
    if(!message) return;

    if (stompClient && stompClient.connected) {
      const chatMessage = {
        roomId: roomId,
        senderId: myUserInfo.id, // Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†ÄÏùò ÏßÑÏßú ID ÏÇ¨Ïö©
        message: message
      };

      stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));
      input.value = '';
    } else {
      alert("WebSocket Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§!");
    }
  }

  function appendToChatBoard(sender, message, isMe) {
    const board = $('#chat-board');
    if (board.innerHTML.includes('WebSocketÏùÑ Ïó∞Í≤∞')) board.innerHTML = '';

    const msgHtml = `
            <div class="chat-item d-flex flex-column ${isMe ? 'align-items-end' : 'align-items-start'}">
                <div><span class="badge ${isMe ? 'bg-primary' : 'bg-secondary'}">${isMe ? 'Me' : 'User '+sender}</span></div>
                <div class="p-2 mt-1 rounded shadow-sm" style="background: ${isMe ? '#e3f2fd' : '#f1f1f1'}; max-width: 85%;">${message}</div>
            </div>`;
    board.innerHTML += msgHtml;
    board.scrollTop = board.scrollHeight;
  }

  async function fetchChatHistory() {
    const roomId = $('#target-id').value;
    try {
      const messages = await apiAction('GET', `/api/chat/rooms/${roomId}/messages`);
      $('#chat-board').innerHTML = '';
      messages.forEach(m => {
        const isMe = myUserInfo && (m.senderId === myUserInfo.id);
        appendToChatBoard(m.senderId, m.message, isMe);
      });
    } catch (e) {}
  }

  function updateAuthStatus(isAuth) {
    const status = $('#token-status');
    status.className = isAuth ? 'badge bg-success' : 'badge bg-danger';
    status.innerText = isAuth ? 'Authenticated' : 'No Token';
  }

  function addLog(msg) {
    const logDiv = $('#log');
    logDiv.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div><hr style="border-color:#444; margin: 5px 0;">`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  // Ï¥àÍ∏∞Ìôî: ÌÜ†ÌÅ∞ ÏûàÏúºÎ©¥ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
  if(localStorage.getItem('accessToken')) getMyInfo();
</script>
</body>
</html>